<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks - Task Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <h1 class="logo">ðŸ“‹ Task Tracker</h1>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="users.html">Users</a></li>
            <li><a href="projects.html">Projects</a></li>
            <li><a href="tasks.html" class="active">Tasks</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div id="alertContainer"></div>

    <div class="card">
        <h2>Tasks Management</h2>
        <button class="btn btn-primary" onclick="showCreateForm()">+ Create New Task</button>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="form-group">
            <label>Filter by Project</label>
            <select id="projectFilter" onchange="loadTasksByProject()">
                <option value="">Select a project</option>
            </select>
        </div>
        <div class="form-group">
            <label>Filter by Status</label>
            <select id="statusFilter" onchange="loadTasksByProject()">
                <option value="">All Statuses</option>
                <option value="TODO">To Do</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
            </select>
        </div>
        <div class="form-group">
            <label>Filter by User</label>
            <select id="userFilter" onchange="loadTasksByUser()">
                <option value="">Select a user</option>
            </select>
        </div>
    </div>

    <!-- Create/Edit Task Form -->
    <div id="taskForm" class="card" style="display: none; margin-top: 20px;">
        <h3 id="formTitle">Create New Task</h3>
        <form onsubmit="saveTask(event)">
            <input type="hidden" id="taskId">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="taskTitle" required minlength="3" maxlength="100">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="taskDescription"></textarea>
            </div>
            <div class="form-group">
                <label>Project *</label>
                <select id="taskProject" required>
                    <option value="">Select a project</option>
                </select>
            </div>
            <div class="form-group">
                <label>Assignee (User) *</label>
                <select id="taskAssignee" required>
                    <option value="">Select a user</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status *</label>
                <select id="taskStatus" required>
                    <option value="TODO">To Do</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority *</label>
                <select id="taskPriority" required>
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                </select>
            </div>
            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="taskDueDate">
            </div>
            <button type="submit" class="btn btn-success">Save Task</button>
            <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
        </form>
    </div>

    <!-- Tasks List -->
    <div id="tasksList" style="margin-top: 20px;">
        <div class="empty-state">
            <h3>No tasks to display</h3>
            <p>Select a project or user filter, or create a new task</p>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="pagination"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/api';
    let currentPage = 0;
    let editingTaskId = null;
    let currentProjectId = null;
    let currentUserId = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadProjects();
        loadUsers();
    });

    async function loadProjects() {
        try {
            const response = await axios.get(`${API_BASE}/projects`, {
                params: { page: 0, size: 100 }
            });

            const projects = response.data.content;
            const filterSelect = document.getElementById('projectFilter');
            const formSelect = document.getElementById('taskProject');

            const options = projects.map(p =>
                `<option value="${p.id}">${p.name}</option>`
            ).join('');

            filterSelect.innerHTML = '<option value="">Select a project</option>' + options;
            formSelect.innerHTML = '<option value="">Select a project</option>' + options;
        } catch (error) {
            console.error('Failed to load projects:', error);
        }
    }

    async function loadUsers() {
        try {
            const response = await axios.get(`${API_BASE}/users`, {
                params: { page: 0, size: 100 }
            });

            const users = response.data.content;
            const filterSelect = document.getElementById('userFilter');
            const formSelect = document.getElementById('taskAssignee');

            const options = users.map(u =>
                `<option value="${u.id}">${u.username} (ID: ${u.id})</option>`
            ).join('');

            filterSelect.innerHTML = '<option value="">Select a user</option>' + options;
            formSelect.innerHTML = '<option value="">Select a user</option>' + options;
        } catch (error) {
            console.error('Failed to load users:', error);
        }
    }

    async function loadTasksByProject(page = 0) {
        const projectId = document.getElementById('projectFilter').value;
        const status = document.getElementById('statusFilter').value;

        if (!projectId) {
            document.getElementById('tasksList').innerHTML = `
                <div class="empty-state">
                    <h3>No project selected</h3>
                    <p>Please select a project to view tasks</p>
                </div>
            `;
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        currentProjectId = projectId;
        currentUserId = null;
        document.getElementById('userFilter').value = '';

        try {
            const params = { page, size: 10 };
            if (status) params.status = status;

            const response = await axios.get(`${API_BASE}/projects/${projectId}/tasks`, { params });
            displayTasks(response.data, page);
        } catch (error) {
            showAlert('Failed to load tasks: ' + error.message, 'error');
        }
    }

    async function loadTasksByUser(page = 0) {
        const userId = document.getElementById('userFilter').value;

        if (!userId) {
            return;
        }

        currentUserId = userId;
        currentProjectId = null;
        document.getElementById('projectFilter').value = '';
        document.getElementById('statusFilter').value = '';

        try {
            const response = await axios.get(`${API_BASE}/users/${userId}/tasks`);
            // This endpoint returns a list, not a page
            displayTasksList(response.data);
        } catch (error) {
            showAlert('Failed to load tasks: ' + error.message, 'error');
        }
    }

    function displayTasks(data, page) {
        const tasksList = document.getElementById('tasksList');

        if (data.content.length === 0) {
            tasksList.innerHTML = '<div class="empty-state"><h3>No tasks found</h3><p>Create your first task</p></div>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        tasksList.innerHTML = data.content.map(task => `
            <div class="list-item">
                <h3>${task.title}</h3>
                <p>${task.description || 'No description'}</p>
                <div style="margin: 10px 0;">
                    <span class="badge badge-${task.status.toLowerCase().replace('_', '-')}">${task.status.replace('_', ' ')}</span>
                    <span class="badge badge-${task.priority.toLowerCase()}">${task.priority}</span>
                </div>
                <p><strong>Project ID:</strong> ${task.projectId} | <strong>Assignee ID:</strong> ${task.assigneeId}</p>
                ${task.dueDate ? `<p><strong>Due Date:</strong> ${task.dueDate}</p>` : ''}
                <div class="list-item-actions">
                    <button class="btn btn-secondary" onclick="editTask(${task.id})">Edit</button>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                </div>
            </div>
        `).join('');

        renderPagination(data);
        currentPage = page;
    }

    function displayTasksList(tasks) {
        const tasksList = document.getElementById('tasksList');
        document.getElementById('pagination').innerHTML = '';

        if (tasks.length === 0) {
            tasksList.innerHTML = '<div class="empty-state"><h3>No tasks found</h3><p>This user has no assigned tasks</p></div>';
            return;
        }

        tasksList.innerHTML = tasks.map(task => `
            <div class="list-item">
                <h3>${task.title}</h3>
                <p>${task.description || 'No description'}</p>
                <div style="margin: 10px 0;">
                    <span class="badge badge-${task.status.toLowerCase().replace('_', '-')}">${task.status.replace('_', ' ')}</span>
                    <span class="badge badge-${task.priority.toLowerCase()}">${task.priority}</span>
                </div>
                <p><strong>Project ID:</strong> ${task.projectId}</p>
                ${task.dueDate ? `<p><strong>Due Date:</strong> ${task.dueDate}</p>` : ''}
                <div class="list-item-actions">
                    <button class="btn btn-secondary" onclick="editTask(${task.id})">Edit</button>
                    <button class="btn btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function showCreateForm() {
        document.getElementById('formTitle').textContent = 'Create New Task';
        document.getElementById('taskId').value = '';
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskProject').value = '';
        document.getElementById('taskAssignee').value = '';
        document.getElementById('taskStatus').value = 'TODO';
        document.getElementById('taskPriority').value = 'MEDIUM';
        document.getElementById('taskDueDate').value = '';
        editingTaskId = null;
        document.getElementById('taskForm').style.display = 'block';
    }

    function hideForm() {
        document.getElementById('taskForm').style.display = 'none';
    }

    async function editTask(id) {
        try {
            const response = await axios.get(`${API_BASE}/tasks/${id}`);
            const task = response.data;

            document.getElementById('formTitle').textContent = 'Edit Task';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskProject').value = task.projectId;
            document.getElementById('taskAssignee').value = task.assigneeId;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskDueDate').value = task.dueDate || '';
            editingTaskId = id;
            document.getElementById('taskForm').style.display = 'block';
        } catch (error) {
            showAlert('Failed to load task: ' + error.message, 'error');
        }
    }

    async function saveTask(event) {
        event.preventDefault();

        const taskData = {
            title: document.getElementById('taskTitle').value,
            description: document.getElementById('taskDescription').value,
            projectId: parseInt(document.getElementById('taskProject').value),
            assigneeId: parseInt(document.getElementById('taskAssignee').value),
            status: document.getElementById('taskStatus').value,
            priority: document.getElementById('taskPriority').value,
            dueDate: document.getElementById('taskDueDate').value || null
        };

        try {
            if (editingTaskId) {
                await axios.put(`${API_BASE}/tasks/${editingTaskId}`, taskData);
                showAlert('Task updated successfully!');
            } else {
                await axios.post(`${API_BASE}/tasks`, taskData);
                showAlert('Task created successfully!');
            }

            hideForm();

            if (currentProjectId) {
                loadTasksByProject(currentPage);
            } else if (currentUserId) {
                loadTasksByUser();
            }
        } catch (error) {
            showAlert('Failed to save task: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    async function deleteTask(id) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        try {
            await axios.delete(`${API_BASE}/tasks/${id}`);
            showAlert('Task deleted successfully!');

            if (currentProjectId) {
                loadTasksByProject(currentPage);
            } else if (currentUserId) {
                loadTasksByUser();
            }
        } catch (error) {
            showAlert('Failed to delete task: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    function renderPagination(data) {
        const pagination = document.getElementById('pagination');
        if (data.totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        if (data.number > 0) {
            html += `<button class="btn btn-secondary" onclick="loadTasksByProject(${data.number - 1})">Previous</button>`;
        }

        html += `<span style="padding: 10px;">Page ${data.number + 1} of ${data.totalPages}</span>`;

        if (data.number < data.totalPages - 1) {
            html += `<button class="btn btn-secondary" onclick="loadTasksByProject(${data.number + 1})">Next</button>`;
        }

        pagination.innerHTML = html;
    }

    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);

        setTimeout(() => alert.remove(), 5000);
    }
</script>
</body>
</html>